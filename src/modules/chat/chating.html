<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>All-in-One Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="chat-container">
        <div class="header">
            <h2>One Chat</h2>
        </div>

        <!-- User ID section -->
        <div class="section">
            <div class="form-group">
                <label for="senderId">Sender ID</label>
                <input type="text" id="senderId" placeholder="Enter your unique sender ID" />
            </div>
            <div class="form-group">
                <label for="receiverId">Receiver ID</label>
                <input type="text" id="receiverId" placeholder="Enter the receiver's unique ID" />
            </div>
            <div class="form-group">
                <label for="token">JWT Token</label>
                <input type="text" id="token" placeholder="Enter JWT token" />
            </div>
            <button id="connectBtn"
                class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-1 px-6 rounded-lg shadow-md transition duration-200">
                Connect
            </button>
        </div>

        <!-- Conversation list section -->
        <div class="section">
            <h4>Conversations</h4>
            <div class="section-header">
            </div>
            <ul id="conversationList" style="list-style-type:circle;"></ul>
        </div>

        <!-- Chat output area -->
        <div class="section">
            <div class="section-header">
                <h4>Chat Messages</h4>
            </div>
            <div id="chat"></div>
        </div>

        <!-- Message input section -->
        <div class="section">
            <div class="form-group">
                <label for="messageInput">Enter Message</label>
                <input type="text" id="messageInput" placeholder="Type your message here..." />
            </div>
            <button id="sendMessageBtn"
                class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-6 rounded-lg shadow-md transition duration-200">Send
                Message</button>
        </div>
    </div>

    <script>
        let socket;
        let conversation_ID = "";
        const chatBox = document.getElementById('chat');
        const tokenInput = document.getElementById('token');
        const connectBtn = document.getElementById('connectBtn');
        const senderIdInput = document.getElementById('senderId');
        const messageInput = document.getElementById('messageInput');
        const receiverIdInput = document.getElementById('receiverId');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const conversationList = document.getElementById('conversationList');

        // Function to fetch conversations
        const getConversations = async () => {
            try {
                const response = await axios.get('http://localhost:4001/api/chat/conversation/user', {
                    headers: {
                        Authorization: `Bearer ${tokenInput.value}`,
                    }
                });
                const conversations = response.data.data;
                conversationList.innerHTML = '';

                conversations.forEach(conversation => {
                    const li = document.createElement('li');
                    li.textContent = `${conversation.type} => Conversation with ${conversation.participant.name}`;
                    li.onclick = () => loadMessages(conversation.id);
                    conversationList.appendChild(li);
                });
            } catch (error) {
                console.error("Error fetching conversations:", error);
            }
        };

        // Function to load messages from a conversation
        const loadMessages = async (conversationId) => {
            conversation_ID = conversationId;
            try {
                const response = await axios.get(`http://localhost:4001/api/chat/message`, {
                    params: { conversation_id: conversationId },
                    headers: {
                        Authorization: `Bearer ${tokenInput.value}`,
                    }
                });

                const messages = response.data.data;
                chatBox.innerHTML = '';
                messages.forEach(message => {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message');
                    messageDiv.classList.add(message.sender.id === senderIdInput.value ? 'self' : 'other');
                    messageDiv.innerHTML = `<strong>${message.sender.name}:</strong> ${message.message}`;
                    chatBox.appendChild(messageDiv);
                });
            } catch (error) {
                console.error("Error loading messages:", error);
            }
        };

        // Display message in the chat box
        const displayMessage = (data) => {
            console.log(data);

            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(data.from === senderIdInput.value ? 'self' : 'other');
            messageElement.innerHTML = `<strong>${data.from}:</strong> ${data.data.message}`;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;  // Auto scroll to the latest message
        };

        // Send message function
        const sendMessage = async () => {
            const message = messageInput.value;
            const token = tokenInput.value;

            if (message && conversation_ID && socket) {
                try {
                    const response = await axios.post(
                        'http://localhost:4001/api/chat/message',
                        {
                            receiver_id: receiverIdInput.value,
                            conversation_id: conversation_ID,
                            message: message,
                        },
                        {
                            headers: {
                                Authorization: `Bearer ${token}`,
                            }
                        }
                    );

                    if (response.data.success) {
                        // Emit the message to other clients via Socket.IO 
                        socket.emit('sendMessage', {
                            to: conversation_ID,
                            data: {
                                sender: { id: senderIdInput.value },
                                message: message,
                            },
                        });
                        displayMessage({
                            from: senderIdInput.value,
                            data: {
                                message: message,
                                conversation_id: conversation_ID,
                                sender_id: senderIdInput.value

                            }
                        });
                        messageInput.value = '';
                    } else {
                        console.error('Failed to send message via API:', response.data.message);
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            } else {
                alert('Please ensure you are connected and fill in the message');
            }

        };

        // Handle Connect button click
        connectBtn.addEventListener('click', () => {
            const token = tokenInput.value;
            const senderId = senderIdInput.value;
            const receiverId = receiverIdInput.value;

            if (token && senderId && receiverId) {
                socket = io('http://localhost:4001', {
                    auth: { token: token },
                });

                socket.on('connect', () => {
                    console.log('Connected to the server');
                    getConversations();  // Fetch all conversations
                });

                // Listen for incoming messages in real-time
                socket.on('message', (data) => {
                    console.log("Received message: ", data);
                    // Only display the message if it's from the current conversation
                    if (data.data.conversation_id === conversation_ID) {
                        displayMessage(data);
                    }
                });
            } else {
                alert('Please fill in all fields');
            }
        });

        // Send message on button click
        sendMessageBtn.addEventListener('click', sendMessage);
    </script>

</body>

</html>